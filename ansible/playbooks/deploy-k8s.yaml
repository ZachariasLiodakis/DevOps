---
- hosts: localhost
  gather_facts: no

  vars:
    kubeconfig: "{{ lookup('env','KUBECONFIG') }}"
    workspace: "{{ lookup('env','WORKSPACE') | default('/var/lib/jenkins/workspace/K8S') }}"

  tasks:
    - name: Apply Spring Deployment
      shell: sudo microk8s.kubectl --kubeconfig="{{ kubeconfig }}" apply -f "{{ workspace }}/k8s/Akinita-spring/spring-deployment.yaml"
      environment:
        KUBECONFIG: "{{ kubeconfig }}"

    - name: Apply Spring Service
      shell: sudo microk8s.kubectl --kubeconfig="{{ kubeconfig }}" apply -f "{{ workspace }}/k8s/Akinita-spring/spring-service.yaml"
      environment:
        KUBECONFIG: "{{ kubeconfig }}"

    - name: Apply Spring Ingress
      shell: sudo microk8s.kubectl --kubeconfig="{{ kubeconfig }}" apply -f "{{ workspace }}/k8s/Akinita-spring/spring-ingress.yaml"
      environment:
        KUBECONFIG: "{{ kubeconfig }}"

    - name: Apply Postgres Deployment
      shell: sudo microk8s.kubectl --kubeconfig="{{ kubeconfig }}" apply -f "{{ workspace }}/k8s/postgres/postgres-deployment.yaml"
      environment:
        KUBECONFIG: "{{ kubeconfig }}"

    - name: Apply Postgres Persistent Volume
      shell: sudo microk8s.kubectl --kubeconfig="{{ kubeconfig }}" apply -f "{{ workspace }}/k8s/postgres/postgres-pvc.yaml"
      environment:
        KUBECONFIG: "{{ kubeconfig }}"

    - name: Apply Postgres Service
      shell: sudo microk8s.kubectl --kubeconfig="{{ kubeconfig }}" apply -f "{{ workspace }}/k8s/postgres/postgres-svc.yaml"
      environment:
        KUBECONFIG: "{{ kubeconfig }}"

    - name: Apply Email Deployment
      shell: sudo microk8s.kubectl --kubeconfig="{{ kubeconfig }}" apply -f "{{ workspace }}/k8s/Email/email-deployment.yaml"
      environment:
        KUBECONFIG: "{{ kubeconfig }}"

    - name: Apply Email Service
      shell: sudo microk8s.kubectl --kubeconfig="{{ kubeconfig }}" apply -f "{{ workspace }}/k8s/Email/email-service.yaml"
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
