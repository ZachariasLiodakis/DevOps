pipeline {
  agent any

  environment {
    ANSIBLE_HOST_KEY_CHECKING = 'False'
    KUBE_CONFIG = credentials('kubeconfig-creds')
    K8S_VM_IP = credentials('k8s_vm_ip')
    WORKSPACE = "${env.WORKSPACE}"
  }

  stages {
    stage('Install prerequisites if needed') {
      steps {
        sh '''
          set -e

          echo "ğŸ” Checking for snap..."
          if ! command -v snap > /dev/null; then
            echo "â¡ snap not found, installing snapd..."
            sudo apt update
            sudo apt install -y snapd
          else
            echo "âœ… snap already installed"
          fi

          echo "ğŸ” Checking for microk8s..."
          if ! snap list microk8s > /dev/null 2>&1; then
            echo "â¡ microk8s not found, installing microk8s..."
            sudo snap install microk8s --classic
          else
            echo "âœ… microk8s already installed"
          fi

          # Î ÏÏÏ„Î¿ setup Î±Î½ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î¾Î±Î½Î±Î³Î¯Î½ÎµÎ¹
          if [ ! -f /var/tmp/microk8s-setup-done ]; then
            echo "â¡ First-time MicroK8s setup"
    
            sudo ufw allow in on eth0
            sudo ufw allow out on eth0
            sudo ufw default allow routed
    
            sudo usermod -a -G microk8s $USER
    
            mkdir -p ~/.kube
            sudo chown -R $USER ~/.kube
    
            echo "alias k='microk8s.kubectl'" >> ~/.profile
            echo "alias c=clear" >> ~/.profile
    
            # reload groups (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬)
            newgrp microk8s
    
            microk8s enable dns ingress storage

            touch /var/tmp/microk8s-setup-done
          else
            echo "âœ… MicroK8s first-time setup already done, skipping"
          fi

          echo "ğŸ” Checking for ansible-playbook..."
          if ! command -v ansible-playbook > /dev/null; then
            echo "â¡ ansible-playbook not found, installing ansible..."
            sudo apt update
            sudo apt install -y ansible
          else
            echo "âœ… ansible-playbook already installed"
          fi

          echo "ğŸ” Checking for kubectl..."
          if ! command -v kubectl > /dev/null; then
            echo "â¡ kubectl not found, installing kubectl via snap..."
            sudo snap install kubectl --classic
          else
            echo "âœ… kubectl already installed"
          fi


          echo "âœ… All prerequisites are now installed!"
        '''
      }
    }

    stage('Checkout') {
      steps {
        git(
          url: 'https://github.com/ZachariasLiodakis/DevOps',
          branch: 'main'
        )
      }
    }

    stage('Deploy to K8s via Ansible') {
      steps {
        script {
          // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î¿Ï Î±ÏÏ‡ÎµÎ¯Î¿Ï… kubeconfig
          writeFile file: '/tmp/kubeconfig', text: "${env.KUBE_CONFIG_CONTENT}"

          // Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î± Î´Î¹ÎºÎ±Î¹Ï‰Î¼Î¬Ï„Ï‰Î½
          sh 'chmod 600 /tmp/kubeconfig'

          ansiblePlaybook(
            playbook: 'ansible/playbooks/deploy-k8s.yaml',
            inventory: 'ansible/playbooks/hosts.yaml',
            extras: "-e kubeconfig=/tmp/kubeconfig",
            colorized: true
          )
        }
      }
    }
  }
}
